<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IOM Prayer Times - Mobile</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            font-family: 'AngsanaUPC', sans-serif;
            background-color: #121212;
            color: #FFFFFF;
            width: 100%;
            min-height: 100vh;
        }

        /* Arabic text font */
        .prayer-name-ar,
        #headerHijri,
        [lang="ar"],
        *[class*="ar"] {
            font-family: 'Arabic Typesetting', serif !important;
        }

        .hidden {
            display: none !important;
        }

        /* Loading Screen */
        #loading {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100vw;
            height: 100vh;
            font-size: 24px;
            font-weight: 700;
            color: #00A86B;
        }

        /* Main Container */
        #app {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            background-color: #121212;
        }

        /* Header */
        .header {
            background-color: #0A2F35;
            padding: 12px 16px;
            text-align: center;
        }

        .app-title {
            font-size: 24px;
            font-weight: 700;
            color: #FFFFFF;
            margin-bottom: 4px;
        }

        .app-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
        }

        .header-date {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 4px;
        }

        .header-hijri {
            font-size: 15px;
            color: rgba(255, 255, 255, 0.8);
        }

        /* Content */
        .content {
            padding: 16px;
        }

        .section-title {
            font-size: 22px;
            font-weight: 600;
            color: #00A86B;
            margin-bottom: 12px;
            text-align: center;
        }

        /* Prayer Cards */
        .prayers-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }

        .prayer-card {
            background-color: #1E1E1E;
            border: 1px solid #2C2C2C;
            border-radius: 8px;
            padding: 10px 12px;
        }

        .prayer-card.next-prayer {
            border: 2px solid #00A86B;
            box-shadow: 0 3px 8px rgba(0, 168, 107, 0.2);
            background-color: rgba(0, 168, 107, 0.05);
        }

        .prayer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .prayer-name-en {
            font-size: 26px;
            font-weight: 700;
            color: #FFFFFF;
        }

        .next-prayer .prayer-name-en {
            color: #00A86B;
        }

        .prayer-name-ar {
            font-size: 20px;
            color: #B0B0B0;
        }

        .prayer-times-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .time-column {
            text-align: center;
        }

        .time-label {
            font-size: 11px;
            font-weight: 600;
            color: #B0B0B0;
            margin-bottom: 2px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .time-value {
            font-size: 20px;
            font-weight: 600;
            color: #FFFFFF;
        }

        .next-prayer .time-value {
            color: #00A86B;
            font-weight: 700;
        }

        /* Special Prayers */
        .special-prayers {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .special-card {
            background-color: #1E1E1E;
            border: 1px solid #2C2C2C;
            border-radius: 8px;
            padding: 10px 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .special-card.next-prayer {
            border: 2px solid #00A86B;
            box-shadow: 0 3px 8px rgba(0, 168, 107, 0.2);
            background-color: rgba(0, 168, 107, 0.05);
        }

        .special-card.disabled-card {
            opacity: 0.5;
        }

        .special-name {
            font-size: 20px;
            font-weight: 600;
            color: #FFFFFF;
        }

        .next-prayer .special-name {
            color: #00A86B;
        }

        .special-time-value {
            font-size: 16px;
            color: #B0B0B0;
        }

        .next-prayer .special-time-value {
            color: #00A86B;
        }

        /* Footer */
        .footer {
            background-color: #0A2F35;
            padding: 10px 16px;
            text-align: center;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: auto;
        }

        .footer-info {
            margin-bottom: 4px;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading">
        Loading Prayer Times...
    </div>

    <!-- Main App -->
    <div id="app" class="hidden">
        <!-- Header -->
        <div class="header">
            <div class="app-title">üïå IOM Prayer Times</div>
            <div class="app-subtitle">Isle of Man Islamic Center</div>
            <div class="header-date" id="headerDate">Loading...</div>
            <div class="header-hijri" id="headerHijri" lang="ar">Loading...</div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Daily Prayer Times -->
            <div class="section-title">Daily Prayer Times</div>
            <div class="prayers-list" id="dailyPrayers"></div>

            <!-- Special Prayers -->
            <div class="section-title">Special Prayers</div>
            <div class="special-prayers" id="specialPrayers"></div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="footer-info">üìç Douglas, Isle of Man</div>
            <div class="footer-info">Method: <span id="method">Loading...</span> | School: <span id="school">Loading...</span></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDQc-8A1Zkz4RnRt54rW4DdaA_v0rfLIBQ",
            authDomain: "iompt-f5b68.firebaseapp.com",
            projectId: "iompt-f5b68",
            storageBucket: "iompt-f5b68.firebasestorage.app",
            messagingSenderId: "111581192358",
            appId: "1:111581192358:web:c9d7be70cc72d8e0ca5467",
            measurementId: "G-TNN65XD7L2"
        };

        console.log('üî• Initializing Firebase...');
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        console.log('‚úÖ Firebase initialized');

        const FIREBASE_CONFIG = {
            COLLECTION: 'prayerTimes',
            DOCUMENTS: {
                API_CONFIG: 'apiConfig',
                DAILY_CONFIG: 'dailyConfig',
                SPECIAL_CONFIG: 'specialConfig'
            }
        };

        // Prayer Names
        const PRAYER_NAMES = {
            fajr: { en: 'Fajr', ar: 'ÿßŸÑŸÅÿ¨ÿ±' },
            dhuhr: { en: 'Dhuhr', ar: 'ÿßŸÑÿ∏Ÿáÿ±' },
            asr: { en: 'Asr', ar: 'ÿßŸÑÿπÿµÿ±' },
            maghrib: { en: 'Maghrib', ar: 'ÿßŸÑŸÖÿ∫ÿ±ÿ®' },
            isha: { en: 'Isha', ar: 'ÿßŸÑÿπÿ¥ÿßÿ°' },
            jumaa: { en: "Jumu'ah", ar: 'ÿßŸÑÿ¨ŸÖÿπÿ©' },
            taraweeh: { en: 'Taraweeh', ar: 'ÿßŸÑÿ™ÿ±ÿßŸàŸäÿ≠' },
            eidFitr: { en: 'Eid al-Fitr', ar: 'ÿπŸäÿØ ÿßŸÑŸÅÿ∑ÿ±' },
            eidAdha: { en: 'Eid al-Adha', ar: 'ÿπŸäÿØ ÿßŸÑÿ£ÿ∂ÿ≠Ÿâ' }
        };

        // Global prayer data
        let prayerData = null;

        async function fetchApiConfig() {
            try {
                const docRef = doc(db, FIREBASE_CONFIG.COLLECTION, FIREBASE_CONFIG.DOCUMENTS.API_CONFIG);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log('‚úÖ API Config fetched');
                    return {
                        method: data.method || 4,
                        latitude: data.latitude || 54.15,
                        longitude: data.longitude || -4.48,
                        methodName: data.methodName || 'Umm al-Qura',
                        schoolName: data.schoolName || 'Shafi'
                    };
                }
                return null;
            } catch (error) {
                console.error('‚ùå Error fetching API config:', error);
                return null;
            }
        }

        async function fetchDailyConfig() {
            try {
                const docRef = doc(db, FIREBASE_CONFIG.COLLECTION, FIREBASE_CONFIG.DOCUMENTS.DAILY_CONFIG);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log('‚úÖ Daily Config fetched');
                    const dailyPrayers = data.dailyPrayers || {};
                    
                    return {
                        mat: {
                            fajr: dailyPrayers.fajr?.mat || '00:00',
                            dhuhr: dailyPrayers.dhuhr?.mat || '00:00',
                            asr: dailyPrayers.asr?.mat || '00:00',
                            maghrib: dailyPrayers.maghrib?.mat || '00:00',
                            isha: dailyPrayers.isha?.mat || '00:00',
                        },
                        mit: {
                            fajr: dailyPrayers.fajr?.mit || '00:00',
                            dhuhr: dailyPrayers.dhuhr?.mit || '00:00',
                            asr: dailyPrayers.asr?.mit || '00:00',
                            maghrib: dailyPrayers.maghrib?.mit || '00:00',
                            isha: dailyPrayers.isha?.mit || '00:00',
                        }
                    };
                }
                return null;
            } catch (error) {
                console.error('‚ùå Error fetching daily config:', error);
                return null;
            }
        }

        async function fetchSpecialConfig() {
            try {
                const docRef = doc(db, FIREBASE_CONFIG.COLLECTION, FIREBASE_CONFIG.DOCUMENTS.SPECIAL_CONFIG);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    console.log('‚úÖ Special Config fetched');
                    return docSnap.data();
                }
                return {};
            } catch (error) {
                console.error('‚ùå Error fetching special config:', error);
                return {};
            }
        }

        async function fetchPrayerTimesFromAladhan(apiConfig) {
            try {
                const url = `https://api.aladhan.com/v1/timings?latitude=${apiConfig.latitude}&longitude=${apiConfig.longitude}&method=${apiConfig.method}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.code === 200 && data.data) {
                    console.log('‚úÖ Aladhan data fetched');
                    return data.data;
                }
                return null;
            } catch (error) {
                console.error('‚ùå Error fetching Aladhan data:', error);
                return null;
            }
        }

        const addMinutes = (timeStr, minutesToAdd) => {
            if (!timeStr || timeStr === '--:--' || timeStr === '00:00') return '00:00';
            const [hours, minutes] = timeStr.split(':').map(Number);
            const totalMinutes = hours * 60 + minutes + minutesToAdd;
            const newHours = Math.floor(totalMinutes / 60) % 24;
            const newMinutes = totalMinutes % 60;
            return `${String(newHours).padStart(2, '0')}:${String(newMinutes).padStart(2, '0')}`;
        };

        async function loadPrayerData() {
            try {
                console.log('üîÑ Loading prayer data...');
                
                const apiConfig = await fetchApiConfig();
                if (!apiConfig) return false;
                
                const dailyConfig = await fetchDailyConfig();
                if (!dailyConfig) return false;
                
                const aladhanData = await fetchPrayerTimesFromAladhan(apiConfig);
                if (!aladhanData) return false;

                const specialConfig = await fetchSpecialConfig();
                
                prayerData = {
                    config: apiConfig,
                    aladhan: aladhanData.timings,
                    date: aladhanData.date,
                    dailyTimes: {
                        fajr: {
                            adhan: aladhanData.timings.Fajr,
                            iqama: dailyConfig.mat.fajr,
                            jamaa: dailyConfig.mit.fajr || addMinutes(dailyConfig.mat.fajr, 5)
                        },
                        dhuhr: {
                            adhan: aladhanData.timings.Dhuhr,
                            iqama: dailyConfig.mat.dhuhr,
                            jamaa: dailyConfig.mit.dhuhr || addMinutes(dailyConfig.mat.dhuhr, 5)
                        },
                        asr: {
                            adhan: aladhanData.timings.Asr,
                            iqama: dailyConfig.mat.asr,
                            jamaa: dailyConfig.mit.asr || addMinutes(dailyConfig.mat.asr, 5)
                        },
                        maghrib: {
                            adhan: aladhanData.timings.Maghrib,
                            iqama: dailyConfig.mat.maghrib,
                            jamaa: dailyConfig.mit.maghrib || addMinutes(dailyConfig.mat.maghrib, 5)
                        },
                        isha: {
                            adhan: aladhanData.timings.Isha,
                            iqama: dailyConfig.mat.isha,
                            jamaa: dailyConfig.mit.isha || addMinutes(dailyConfig.mat.isha, 5)
                        }
                    },
                    specialPrayers: specialConfig
                };

                return true;
            } catch (error) {
                console.error('‚ùå Error loading prayer data:', error);
                return false;
            }
        }

        function findNextEvent() {
            if (!prayerData) return null;

            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            const events = [];

            ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].forEach(prayer => {
                const iqamaTime = prayerData.dailyTimes[prayer]?.iqama;
                if (iqamaTime && iqamaTime !== '00:00') {
                    const [h, m] = iqamaTime.split(':').map(Number);
                    const minutes = h * 60 + m;
                    events.push({
                        prayer,
                        time: iqamaTime,
                        minutes,
                        displayName: PRAYER_NAMES[prayer].en,
                        displayNameAr: PRAYER_NAMES[prayer].ar,
                        isTomorrow: minutes <= currentTime
                    });
                }
            });

            const dayOfWeek = now.getDay();
            if (dayOfWeek === 5 && prayerData.specialPrayers?.jumaa?.iqama) {
                const time = prayerData.specialPrayers.jumaa.iqama;
                if (time !== '00:00') {
                    const [h, m] = time.split(':').map(Number);
                    const minutes = h * 60 + m;
                    events.push({
                        prayer: "Jumu'ah",
                        time,
                        minutes,
                        displayName: PRAYER_NAMES.jumaa.en,
                        displayNameAr: PRAYER_NAMES.jumaa.ar,
                        isTomorrow: minutes <= currentTime
                    });
                }
            }

            if (prayerData.specialPrayers?.taraweeh?.time) {
                const time = prayerData.specialPrayers.taraweeh.time;
                if (time !== '00:00') {
                    const [h, m] = time.split(':').map(Number);
                    const minutes = h * 60 + m;
                    events.push({
                        prayer: 'taraweeh',
                        time,
                        minutes,
                        displayName: PRAYER_NAMES.taraweeh.en,
                        displayNameAr: PRAYER_NAMES.taraweeh.ar,
                        isTomorrow: minutes <= currentTime
                    });
                }
            }

            events.sort((a, b) => {
                if (a.isTomorrow !== b.isTomorrow) return a.isTomorrow ? 1 : -1;
                return a.minutes - b.minutes;
            });

            return events[0] || null;
        }

        function renderPrayerTimes() {
            const container = document.getElementById('dailyPrayers');
            const nextEvent = findNextEvent();
            const prayers = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'];

            let html = '';
            prayers.forEach(prayer => {
                const times = prayerData.dailyTimes[prayer];
                const adhan = times?.adhan || '--:--';
                const iqama = times?.iqama || '--:--';
                const jamaa = times?.jamaa || '--:--';
                
                const isNext = nextEvent && nextEvent.prayer === prayer;
                
                html += `
                    <div class="prayer-card ${isNext ? 'next-prayer' : ''}" data-prayer="${prayer}">
                        <div class="prayer-header">
                            <div class="prayer-name-en">${PRAYER_NAMES[prayer].en}</div>
                            <div class="prayer-name-ar" lang="ar">${PRAYER_NAMES[prayer].ar}</div>
                        </div>
                        <div class="prayer-times-row">
                            <div class="time-column">
                                <div class="time-label">Adhan</div>
                                <div class="time-value">${adhan}</div>
                            </div>
                            <div class="time-column">
                                <div class="time-label">Iqama</div>
                                <div class="time-value">${iqama}</div>
                            </div>
                            <div class="time-column">
                                <div class="time-label">Jama'ah</div>
                                <div class="time-value">${jamaa}</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderSpecialPrayers() {
            const container = document.getElementById('specialPrayers');
            const nextEvent = findNextEvent();
            let html = '';

            if (prayerData.specialPrayers?.jumaa) {
                const j = prayerData.specialPrayers.jumaa;
                const hasData = j.adhan || j.iqama;
                const isNext = nextEvent && nextEvent.prayer === "Jumu'ah";
                html += `
                    <div class="special-card ${isNext ? 'next-prayer' : ''}${!hasData ? ' disabled-card' : ''}" data-prayer="jumaa">
                        <div class="special-name">${PRAYER_NAMES.jumaa.en} <span style="opacity:0.5;font-weight:400;font-size:0.85em;">(${PRAYER_NAMES.jumaa.ar})</span></div>
                        <div class="special-time-value">${hasData ? `Khutba: ${j.adhan || '--:--'} | Iqama: ${j.iqama || '--:--'}` : 'Not today'}</div>
                    </div>
                `;
            }

            if (prayerData.specialPrayers?.taraweeh) {
                const t = prayerData.specialPrayers.taraweeh;
                const hasData = t.time && t.time !== '' && t.time !== '00:00';
                const isNext = nextEvent && nextEvent.prayer === 'taraweeh';
                html += `
                    <div class="special-card ${isNext ? 'next-prayer' : ''}${!hasData ? ' disabled-card' : ''}" data-prayer="taraweeh">
                        <div class="special-name">${PRAYER_NAMES.taraweeh.en} <span style="opacity:0.5;font-weight:400;font-size:0.85em;">(${PRAYER_NAMES.taraweeh.ar})</span></div>
                        <div class="special-time-value">${hasData ? t.time : 'Not today'}</div>
                    </div>
                `;
            }

            if (prayerData.specialPrayers?.eidFitr) {
                const e = prayerData.specialPrayers.eidFitr;
                const hasData = (e.prayer1?.time && e.prayer1.time !== '00:00') || (e.prayer2?.time && e.prayer2.time !== '00:00');
                if (hasData) {
                    const isNext = nextEvent && nextEvent.prayer === 'eidFitr';
                    let timeDisplay = '';
                    if (e.prayer1?.time && e.prayer1.time !== '00:00') timeDisplay += `1st: ${e.prayer1.time}`;
                    if (e.prayer2?.time && e.prayer2.time !== '00:00') timeDisplay += `${timeDisplay ? ' | ' : ''}2nd: ${e.prayer2.time}`;
                    html += `
                        <div class="special-card ${isNext ? 'next-prayer' : ''}" data-prayer="eidFitr">
                            <div class="special-name">${PRAYER_NAMES.eidFitr.en} <span style="opacity:0.5;font-weight:400;font-size:0.85em;">(${PRAYER_NAMES.eidFitr.ar})</span></div>
                            <div class="special-time-value">${timeDisplay}</div>
                        </div>
                    `;
                }
            }

            if (prayerData.specialPrayers?.eidAdha) {
                const e = prayerData.specialPrayers.eidAdha;
                const hasData = (e.prayer1?.time && e.prayer1.time !== '00:00') || (e.prayer2?.time && e.prayer2.time !== '00:00');
                if (hasData) {
                    const isNext = nextEvent && nextEvent.prayer === 'eidAdha';
                    let timeDisplay = '';
                    if (e.prayer1?.time && e.prayer1.time !== '00:00') timeDisplay += `1st: ${e.prayer1.time}`;
                    if (e.prayer2?.time && e.prayer2.time !== '00:00') timeDisplay += `${timeDisplay ? ' | ' : ''}2nd: ${e.prayer2.time}`;
                    html += `
                        <div class="special-card ${isNext ? 'next-prayer' : ''}" data-prayer="eidAdha">
                            <div class="special-name">${PRAYER_NAMES.eidAdha.en} <span style="opacity:0.5;font-weight:400;font-size:0.85em;">(${PRAYER_NAMES.eidAdha.ar})</span></div>
                            <div class="special-time-value">${timeDisplay}</div>
                        </div>
                    `;
                }
            }

            container.innerHTML = html || '<div style="padding:10px;color:#B0B0B0;font-size:13px;text-align:center;">No special prayers</div>';
        }

        function updateConfigInfo() {
            document.getElementById('method').textContent = prayerData.config.methodName;
            document.getElementById('school').textContent = prayerData.config.schoolName;
        }

        function updateCurrentDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('headerDate').textContent = now.toLocaleDateString('en-GB', options);
            
            if (prayerData && prayerData.date && prayerData.date.hijri) {
                const hijri = prayerData.date.hijri;
                document.getElementById('headerHijri').textContent = `${hijri.day} ${hijri.month.en} ${hijri.year} AH`;
            }
        }

        async function init() {
            console.log('üöÄ Initializing...');
            
            const success = await loadPrayerData();
            
            if (!success) {
                document.getElementById('loading').innerHTML = '‚ùå Failed to load. Retrying...';
                setTimeout(init, 5000);
                return;
            }
            
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            renderPrayerTimes();
            renderSpecialPrayers();
            updateConfigInfo();
            updateCurrentDate();
            
            console.log('‚úÖ Initialized');
            
            setInterval(() => {
                updateCurrentDate();
                renderPrayerTimes();
                renderSpecialPrayers();
            }, 60000);
            
            setTimeout(() => location.reload(), 60 * 60 * 1000);
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
